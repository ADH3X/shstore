{% extends "base.html" %}

{% block content %}

<section class="page-section page-section--wide product-page">

  <div class="product-layout">
    <!-- ======================= GALERÍA / SLIDER ======================= -->
    <div class="product-gallery card">
      <div class="gallery-inner">
        <button type="button" class="gallery-arrow gallery-arrow--left" id="gallery-prev">‹</button>

        <div class="gallery-main" id="gallery-main">
          {% if product.images %}
            {% for img in product.images %}
              <img
                class="gallery-slide {% if loop.first %}is-active{% endif %}"
                src="{{ url_for('static', filename=img.image_url) }}"
                alt="Imagen {{ loop.index }} de {{ product.name }}"
              >
            {% endfor %}
          {% elif product.image_url %}
            <img
              class="gallery-slide is-active"
              src="{{ url_for('static', filename=product.image_url) }}"
              alt="{{ product.name }}"
            >
          {% else %}
            <img
              class="gallery-slide is-active"
              src="https://via.placeholder.com/800x800?text=Sin+imagen"
              alt="Sin imagen"
            >
          {% endif %}
        </div>

        <button type="button" class="gallery-arrow gallery-arrow--right" id="gallery-next">›</button>
      </div>

      <!-- Puntos del slider -->
      <div class="gallery-dots" id="gallery-dots">
        {% if product.images %}
          {% for img in product.images %}
            <button
              type="button"
              class="gallery-dot {% if loop.first %}is-active{% endif %}"
              data-index="{{ loop.index0 }}"
            ></button>
          {% endfor %}
        {% elif product.image_url %}
          <button
            type="button"
            class="gallery-dot is-active"
            data-index="0"
          ></button>
        {% endif %}
      </div>
    </div>

    <!-- ======================= INFORMACIÓN DEL PRODUCTO ======================= -->
    <div class="product-info">
      <header class="product-header">
        {% if product.category %}
          <p class="product-category">
            {{ product.category.name }}
          </p>
        {% endif %}

        <h1 class="product-title">
          {{ product.name }}
        </h1>

        <p class="product-price">
          {{ '%.2f'|format(product.price) }} Bs
        </p>
      </header>

      {% if product.description %}
        <p class="product-description">
          {{ product.description }}
        </p>
      {% endif %}

      <!-- META / CARACTERÍSTICAS -->
      <div class="product-meta">
        <ul>
          {% if product.brand %}
            <li><span>Marca</span><strong>{{ product.brand }}</strong></li>
          {% endif %}

          {% if product.category %}
            <li><span>Categoría</span><strong>{{ product.category.name }}</strong></li>
          {% endif %}

          {% if product.gender %}
            <li><span>Género</span><strong>{{ product.gender }}</strong></li>
          {% endif %}

          {% if product.size_clothes %}
            <li><span>Talla ropa</span><strong>{{ product.size_clothes }}</strong></li>
          {% endif %}

          {% if product.size_shoes %}
            <li><span>Talla calzado</span><strong>{{ product.size_shoes }}</strong></li>
          {% endif %}

          {% if product.color %}
            <li><span>Color</span><strong>{{ product.color }}</strong></li>
          {% endif %}

          {% if product.color_detail %}
            <li><span>Color (detalle)</span><strong>{{ product.color_detail }}</strong></li>
          {% endif %}

          {% if product.material %}
            <li><span>Material</span><strong>{{ product.material }}</strong></li>
          {% endif %}

          {% if product.condition %}
            <li><span>Estado</span><strong>{{ product.condition }}</strong></li>
          {% endif %}
        </ul>
      </div>

      <!-- Botones de compra -->
      <div class="product-actions">
        <a href="{{ wa_link_1 }}" class="btn primary" target="_blank" rel="noopener">
          Operador 1
        </a>
        <a href="{{ wa_link_2 }}" class="btn primary ghost" target="_blank" rel="noopener">
          Operador 2
        </a>
      </div>

      <p class="product-note">
        La compra se coordina directamente por WhatsApp.
      </p>
    </div>
  </div>

  <!-- ======================= TAMBIÉN TE PUEDE INTERESAR ======================= -->
  {% if related_products and related_products|length > 0 %}
    <section class="related-section">
      <h2 class="related-title">También te puede interesar</h2>

      <div class="related-grid">
        {% for p in related_products %}
          <a href="{{ url_for('public.product_detail', slug=p.slug) }}" class="related-card">
            <div class="related-thumb">
              {% if p.image_url %}
                <img src="{{ url_for('static', filename=p.image_url) }}" alt="{{ p.name }}">
              {% elif p.images %}
                <img src="{{ url_for('static', filename=p.images[0].image_url) }}" alt="{{ p.name }}">
              {% else %}
                <img src="https://via.placeholder.com/600x800?text=Sin+imagen" alt="{{ p.name }}">
              {% endif %}
            </div>
            <div class="related-body">
              <p class="related-name">{{ p.name }}</p>
              <p class="related-price">{{ '%.2f'|format(p.price) }} Bs</p>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  <!-- ======================= OVERLAY DE ZOOM ======================= -->
  <div id="image-zoom-overlay" class="image-zoom-overlay">
    <div class="image-zoom-inner">
      <button type="button" class="image-zoom-close" id="zoom-close">×</button>
      <img id="zoom-image" src="" alt="">
    </div>
  </div>

</section>

<!-- ======================= ESTILOS LOCALES ======================= -->
<style>
  .product-page{
    padding-top:1.5rem;
  }

  .product-layout{
    display:flex;
    gap:2.5rem;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  .product-gallery{
    flex:1 1 52%;
    min-width:280px;
  }

  .product-info{
    flex:1 1 38%;
    min-width:260px;
  }

  /* ========= Romper el “encuadre” de la card global ========= */
  .product-gallery.card{
    background:transparent;
    padding:0;
    border-radius:0;
    box-shadow:none;
  }

  /* ======= GALERÍA ======= */
  .gallery-inner{
    position:relative;
    overflow:hidden;
    border-radius:1.6rem;
    background:#101319;
    box-shadow:0 16px 40px rgba(0,0,0,0.55);
    touch-action:pan-y;
  }

  .gallery-main{
    position:relative;
    width:100%;
    padding-top:90%;
    touch-action:pan-y;
    cursor:zoom-in;
  }

  .gallery-slide{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    opacity:0;
    pointer-events:none;
    transition:opacity .18s ease;
  }

  .gallery-slide.is-active{
    opacity:1;
    pointer-events:auto;
  }

  .gallery-arrow{
    position:absolute;
    top:50%;
    transform:translateY(-50%);
    width:44px;
    height:44px;
    border-radius:999px;
    border:none;
    background:#1f2430;
    color:#fff;
    font-size:1.4rem;
    line-height:44px;
    padding:0;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    z-index:5;
  }

  .gallery-arrow--left{ left:10px; }
  .gallery-arrow--right{ right:10px; }

  .gallery-dots{
    display:flex;
    justify-content:center;
    gap:6px;
    padding:0.65rem 0.4rem 0.25rem;
  }

  .gallery-dot{
    width:7px;
    height:7px;
    border-radius:999px;
    border:none;
    background:#444b57;
    cursor:pointer;
  }

  .gallery-dot.is-active{
    background:#22c76e;
    width:16px;
  }

  /* ======= INFO PRINCIPAL ======= */
  .product-header{
    margin-bottom:0.9rem;
  }

  .product-category{
    font-size:0.8rem;
    text-transform:uppercase;
    letter-spacing:0.08em;
    opacity:0.7;
    margin-bottom:0.25rem;
  }

  .product-title{
    font-size:1.7rem;
    margin:0 0 .25rem;
  }

  .product-price{
    font-size:1.4rem;
    font-weight:600;
    margin:0 0 1rem;
  }

  .product-description{
    font-size:0.97rem;
    line-height:1.6;
    opacity:0.92;
    margin-bottom:1.1rem;
  }

  .product-meta ul{
    list-style:none;
    padding:0;
    margin:0 0 1.3rem;
    font-size:0.9rem;
  }

  .product-meta li{
    display:flex;
    justify-content:space-between;
    gap:1rem;
    padding:0.18rem 0;
    border-bottom:1px dashed rgba(255,255,255,0.06);
  }

  .product-meta span{
    opacity:0.7;
  }

  .product-meta strong{
    font-weight:500;
  }

  .product-actions{
    display:flex;
    gap:0.75rem;
    margin-bottom:0.65rem;
  }

  .product-note{
    font-size:0.8rem;
    opacity:0.7;
  }

  /* ======= RELACIONADOS ======= */
  .related-section{
    margin-top:2.4rem;
    padding-top:1.6rem;
    border-top:1px solid rgba(255,255,255,0.04);
  }

  .related-title{
    font-size:1.15rem;
    margin:0 0 0.8rem;
    opacity:0.95;
  }

  .related-grid{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:0.9rem;
  }

  .related-card{
    display:flex;
    flex-direction:column;
    text-decoration:none;
    background:#11151d;
    border-radius:1.2rem;
    padding:0.65rem 0.65rem 0.85rem;
    transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    opacity:0.95;
  }

  .related-card:hover{
    transform:translateY(-3px);
    box-shadow:0 12px 28px rgba(0,0,0,.45);
    opacity:1;
  }

  .related-thumb{
    width:100%;
    padding-top:115%;
    position:relative;
    border-radius:1rem;
    overflow:hidden;
    background:#05070b;
    margin-bottom:0.45rem;
  }

  .related-thumb img{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .related-body{
    text-align:center;
    font-size:0.85rem;
  }

  .related-name{
    margin:0 0 0.15rem;
  }

  .related-price{
    margin:0;
    font-weight:600;
    font-size:0.9rem;
  }

  /* ======= OVERLAY ZOOM ======= */
  body.no-scroll{
    overflow:hidden;
  }

  .image-zoom-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.92);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:9999;
  }

  .image-zoom-overlay.is-open{
    display:flex;
  }

  .image-zoom-inner{
    position:relative;
    width:100%;
    height:100%;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:auto;
    padding:1rem;
    touch-action:auto; /* aquí dejamos al navegador manejar pinch-zoom */
  }

  #zoom-image{
    max-width:none;
    width:100%;
    height:auto;
  }

  .image-zoom-close{
    position:absolute;
    top:1rem;
    right:1rem;
    width:40px;
    height:40px;
    border-radius:999px;
    border:none;
    background:rgba(0,0,0,0.7);
    color:#fff;
    font-size:1.5rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
  }

  /* ======= RESPONSIVE ======= */
  @media (max-width: 1200px){
    .related-grid{
      grid-template-columns:repeat(3,minmax(0,1fr));
    }
  }

  @media (max-width: 900px){
    .product-layout{
      flex-direction:column;
      gap:1.75rem;
    }
    .product-gallery{
      order:-1;
      max-width:520px;
      margin:0 auto;
    }
    .related-grid{
      grid-template-columns:repeat(3,minmax(0,1fr));
    }
  }

  @media (max-width: 768px){
    .gallery-main{
      padding-top:85%;
    }
    .product-title{
      font-size:1.5rem;
    }
    .product-price{
      font-size:1.25rem;
    }
  }

  @media (max-width: 600px){
    .product-page{
      padding-top:1rem;
    }
    .product-layout{
      gap:1.5rem;
    }

    .product-gallery{
      width:100%;
      max-width:none;
      margin:0;
    }

    .gallery-inner{
      border-radius:1.2rem;
      box-shadow:0 10px 26px rgba(0,0,0,0.45);
    }

    .gallery-main{
      padding-top:82%;
    }

    .related-grid{
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:0.75rem;
    }
    .related-card{
      padding:0.55rem 0.55rem 0.75rem;
    }
    .related-title{
      font-size:1.05rem;
      margin-bottom:0.65rem;
    }
  }

  @media (max-width: 420px){
    .gallery-main{
      padding-top:80%;
    }
    .related-grid{
      grid-template-columns:repeat(2,minmax(0,1fr));
    }
  }
</style>

<!-- ======================= JS SLIDER + SWIPE + ZOOM ======================= -->
<script>
  (function() {
    var slides   = Array.prototype.slice.call(document.querySelectorAll(".gallery-slide"));
    var dots     = Array.prototype.slice.call(document.querySelectorAll(".gallery-dot"));
    var btnPrev  = document.getElementById("gallery-prev");
    var btnNext  = document.getElementById("gallery-next");
    var main     = document.getElementById("gallery-main");

    var zoomOverlay = document.getElementById("image-zoom-overlay");
    var zoomImg     = document.getElementById("zoom-image");
    var zoomClose   = document.getElementById("zoom-close");

    if (!slides.length) {
      if (btnPrev) btnPrev.style.display = "none";
      if (btnNext) btnNext.style.display = "none";
      return;
    }

    var index = 0;

    function setActive(i){
      if (!slides.length) return;
      if (i < 0) i = slides.length - 1;
      if (i >= slides.length) i = 0;
      index = i;

      slides.forEach(function(slide, idx){
        slide.classList.toggle("is-active", idx === index);
      });
      dots.forEach(function(dot, idx){
        dot.classList.toggle("is-active", idx === index);
      });
    }

    if (btnPrev) {
      btnPrev.addEventListener("click", function(e){
        e.preventDefault();
        setActive(index - 1);
      });
    }
    if (btnNext) {
      btnNext.addEventListener("click", function(e){
        e.preventDefault();
        setActive(index + 1);
      });
    }

    dots.forEach(function(dot){
      dot.addEventListener("click", function(e){
        e.preventDefault();
        var i = parseInt(dot.getAttribute("data-index"), 10) || 0;
        setActive(i);
      });
    });

    // ===== Swipe en móvil =====
    if (main) {
      var startX = 0;
      var startY = 0;
      var threshold = 25;

      main.addEventListener("touchstart", function(e){
        if (!e.touches || !e.touches.length) return;
        var t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
      }, { passive:false });

      main.addEventListener("touchend", function(e){
        if (!e.changedTouches || !e.changedTouches.length) return;
        var t = e.changedTouches[0];
        var endX = t.clientX;
        var endY = t.clientY;

        var dx = endX - startX;
        var dy = endY - startY;

        if (Math.abs(dy) > Math.abs(dx)) return;

        if (Math.abs(dx) > threshold){
          e.preventDefault();
          if (dx < 0){
            setActive(index + 1);
          } else {
            setActive(index - 1);
          }
        }
      }, { passive:false });

      // ===== Click / tap para abrir zoom =====
      main.addEventListener("click", function(){
        if (!zoomOverlay || !zoomImg) return;
        var active = document.querySelector(".gallery-slide.is-active");
        if (!active) return;
        zoomImg.src = active.src;
        zoomImg.alt = active.alt || "";
        zoomOverlay.classList.add("is-open");
        document.body.classList.add("no-scroll");
      });
    }

    // ===== Cerrar zoom =====
    function closeZoom(){
      if (!zoomOverlay) return;
      zoomOverlay.classList.remove("is-open");
      document.body.classList.remove("no-scroll");
    }

    if (zoomClose){
      zoomClose.addEventListener("click", function(e){
        e.preventDefault();
        closeZoom();
      });
    }

    if (zoomOverlay){
      zoomOverlay.addEventListener("click", function(e){
        if (e.target === zoomOverlay){
          closeZoom();
        }
      });
    }

    // Ocultar flechas si solo hay una imagen
    if (slides.length === 1) {
      if (btnPrev) btnPrev.style.display = "none";
      if (btnNext) btnNext.style.display = "none";
    }
  })();
</script>

{% endblock %}
